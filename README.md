# CVELens Query Helm Chart

This is a Helm chart for deploying **CVELens Query** on a Kubernetes cluster

## Prerequisites
- AWS Infrastructure setup using Terraform located [here](https://github.com/cvelens/eks-infra-terraform)
- Helm 3.0+ (for manual deployment) [guide](https://helm.sh/docs/intro/install/)
- CVELens Processor Helm chart deployed [here](https://github.com/cvelens/helm-cve-processor)
- CVELens Consumer Helm chart deployed [here](https://github.com/cvelens/helm-cve-consumer)
- A namespace where the chart will be deployed (default is 'cve-generator' and is created by the Terraform IaC code located [here](https://github.com/cvelens/eks-infra-terraform))


## Working
The helm chart deploys the CVELens Generator application on a Kubernetes cluster using the webapp Docker image located [here](https://github.com/cvelens/llm-webapp-cve-chatbot). 

## Files
The CVELens Generator Helm chart consists of the following components:
- **cronjob.yaml**: Creates a cron job object that runs the CVE Generator application every hour to generate a new index of CVEs.
- **job.yaml**: Creates a job object that runs the CVE Generator application once to generate an initial index of CVEs upon deployment.
- **pvc.yaml**: Creates a Persistent Volume Claim to store the generated FAISS index of CVEs.
- **serviceaccount.yaml**: Creates a service account for the generator application.

## Usage

```bash
helm install cve-generator ./path/to/release -n cve-generator 
```

Alternatively, a YAML file that specifies the values for the parameters can be provided while installing the chart:

```bash
helm install cve-generator ./path/to/release -n cve-generator -f values.yaml
```

## Troubleshooting
If you encounter issues:

Check the status of the pods:
```bash
kubectl get pods -n cve-generator -l app=cve-generator
```

View the logs of the generator application:
```bash
kubectl logs -n cve-generator -l app=cve-generator -f
```

Access the shell of the generator pod for debugging:
```bash
kubectl exec -it <cve-generator-pod> -n cve-generator -- sh
```

## Upgrading the Chart 

To upgrade the `cve-generator` release:

```bash
helm upgrade cve-generator ./path/to/release -n cve-generator
```

Ensure the chart version is updated in the `Chart.yaml` before upgrading.

## Uninstalling the Chart (manual)

To uninstall/delete the `cve-generator` helm release:

```bash
helm uninstall cve-generator -n cve-generator
```

The command removes all the Kubernetes components associated with the chart.

## GitHub Actions Workflow

A GitHub Actions workflow is included to lint and dry-run the Helm chart and subsequently create a tag and publish the chart to the GitHub repository.

This workflow:
1. Checks the code and sets up Terraform.
2. Setups Helm and runs `helm lint` to lint the Helm chart, followed by `helm template` to dry-run the Helm chart.
4. Gets the chart version from the `Chart.yaml` file, creates a tag, packages the chart, and publishes it to the GitHub repository.

## Additional Information

This helm chart is primarly designed to be used in the CVELens project. The chart can be used independently by providing the necessary configurations and dependencies however, it is recommended to be used with the CVELens application only. 